<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Roja AI Chat - Final</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Inter:wght@400;500;600&display=swap');
  * { box-sizing: border-box; }
  body {
    font-family: 'Inter', 'Poppins', sans-serif;
    margin: 0;
    background-color: #0a0f24;
    color: #fff;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* Header */
  .chat-header {
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 18px;
    background: linear-gradient(135deg,#111831,#1c244a);
    border-bottom:1px solid #2a2f4a;
    position:fixed; top:0; left:0; right:0; z-index:10;
    box-shadow:0 2px 10px rgba(0,0,0,0.4);
  }
  .chat-header-left { display:flex; align-items:center; }
  .chat-header img { width:48px; height:48px; border-radius:50%; object-fit:cover; margin-right:10px; border:2px solid #0078ff; }
  .chat-header h2 { margin:0; font-size:20px; font-weight:600; }
  .chat-header-right button {
    background:#1f2745; border:none; color:#bbb; font-size:14px; padding:6px 10px; border-radius:6px; cursor:pointer; transition:0.3s;
  }
  .chat-header-right button:hover { color:#fff; background:#0078ff; }

  /* Chat box */
  .chat-box {
    flex:1; overflow-y:auto; scroll-behavior:smooth;
    display:flex; flex-direction:column; padding:15px;
    margin-top:75px; margin-bottom:80px;
  }
  .message {
    margin:10px 0; max-width:75%; padding:14px 18px;
    border-radius:14px; line-height:1.6; word-wrap:break-word;
    position:relative; font-size:15px; animation: bubbleAppear .28s ease;
  }
  .user { background:#0078ff; align-self:flex-end; border-bottom-right-radius:0; margin-right:5px; }
  .bot  { background:#1b2140; align-self:flex-start; border-bottom-left-radius:0; margin-left:5px; font-family: 'Inter', sans-serif; }
  @keyframes bubbleAppear { from { transform: translateY(6px); opacity:0 } to { transform: translateY(0); opacity:1 } }

  .bot p { margin:6px 0; line-height:1.6; }
  .bot pre, .bot code {
    display:block; background:#0f1730; border-radius:8px; padding:8px 10px; margin-top:6px;
    white-space:pre-wrap; word-wrap:break-word; font-family: 'JetBrains Mono', monospace; font-size:14px; color:#00d4ff;
  }

  .typing-indicator { display:flex; align-items:center; gap:3px; }
  .typing-indicator span { width:6px; height:6px; background:#0078ff; border-radius:50%; display:inline-block; animation:bounce 0.6s infinite alternate; }
  .typing-indicator span:nth-child(2) { animation-delay:0.2s; }
  .typing-indicator span:nth-child(3) { animation-delay:0.4s; }
  @keyframes bounce { to { transform: translateY(-5px); } }

  .copy-btn { position:absolute; bottom:8px; right:8px; background:#0078ff; color:white; border:none; font-size:12px; padding:4px 8px; border-radius:5px; cursor:pointer; opacity:0; transition:0.2s; }
  .bot:hover .copy-btn { opacity:1; }
  .copy-btn:hover { background:#005ec3; }

  /* Input area - preserve original layout */
  .chat-input {
    position:fixed; bottom:0; left:0; right:0; display:flex; padding:12px;
    background:#141a35; border-top:1px solid #2a2f4a; z-index:20; align-items:center;
  }
  .chat-input input[type="text"] {
    flex:1; padding:10px 14px; border:none; border-radius:8px; font-size:15px; outline:none; background:#1f2745; color:#fff;
  }
  /* file upload hidden + styled label (ke kanan sebelum tombol Kirim) */
  .chat-input input[type="file"] { display:none; }
  .upload-label {
    background:#1f2745; color:#fff; border-radius:8px; padding:8px 10px; margin-left:10px; cursor:pointer; border:1px solid #2a2f4a;
  }
  .chat-input button { background:#0078ff; color:#fff; border:none; padding:10px 18px; margin-left:10px; border-radius:8px; cursor:pointer; transition:0.2s; }
  .chat-input button:hover { background:#0060d4; }

  .footer { text-align:center; padding:8px; font-size:12px; color:#aaa; font-style:italic; position:fixed; bottom:60px; left:0; right:0; background:transparent; }

  /* preview image style - same as previous */
  .preview-img { max-width:200px; border-radius:10px; margin-top:8px; display:block; }

  /* small responsive tweak */
  @media (max-width:480px){
    .chat-box { padding:12px; margin-top:68px; margin-bottom:100px; }
    .message { max-width:85%; padding:12px; }
  }
</style>
</head>
<body>

  <div class="chat-header">
    <div class="chat-header-left">
      <img src="roja-avatar.png" alt="Roja AI Avatar">
      <h2>Roja AI</h2>
    </div>
    <div class="chat-header-right">
      <button onclick="newChat()">Percakapan Baru</button>
      <button onclick="toggleFullscreen()">Fullscreen</button>
    </div>
  </div>

  <div class="chat-box" id="chatBox"></div>

  <div class="chat-input">
    <input id="userInput" type="text" placeholder="Ketik pesan..." />
    <!-- file upload (gambar atau file lain) -->
    <label for="fileUpload" class="upload-label" title="Upload file (gambar/pdf/txt)">üìé</label>
    <input id="fileUpload" type="file" accept="image/*,.pdf,.txt,.doc,.docx" />
    <button id="sendBtn" onclick="handleSendClick()">Kirim</button>
  </div>

  <div class="footer">copyright@RojaServer | V2</div>

<script>
/* ====== CONFIG ======
 * Ganti GEMINI_API_KEY dengan key yang punya akses ke model multimodal (gemini-1.5-flash / gemini-1.5-pro)
 * Jika kamu menggunakan key lain (OpenAI/HuggingFace), beritahu aku untuk adaptasi.
 */
const GEMINI_API_KEY = "AIzaSyC310duBltZgbkMMfqRoAn6qVELo7x2slI";
const GEMINI_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent";
/* ===================== */

const chatBox = document.getElementById('chatBox');
const userInput = document.getElementById('userInput');
const fileUpload = document.getElementById('fileUpload');
const sendBtn = document.getElementById('sendBtn');

let conversationHistory = []; // menyimpan role/content untuk context

// Load previous chat if exists
window.onload = () => {
  const savedHTML = localStorage.getItem('roja_chat');
  const savedHistory = localStorage.getItem('roja_history');
  if (savedHTML) chatBox.innerHTML = savedHTML;
  if (savedHistory) conversationHistory = JSON.parse(savedHistory);
  if (!savedHTML) appendBot("<p>Halo, aku <b>Roja AI</b> ü§ñ<br>Kirim pesan atau upload file/gambar untuk aku analisis!</p>");
  scrollToBottom();
};

// helper: scroll
function scrollToBottom(){ chatBox.scrollTop = chatBox.scrollHeight; }

// Append user message (ke UI & simpan)
function appendUser(contentHTML) {
  const div = document.createElement('div');
  div.className = 'message user';
  div.innerHTML = contentHTML;
  chatBox.appendChild(div);
  saveChat();
  scrollToBottom();
}

// Append bot message (returns the element for later editing)
function appendBot(contentHTML) {
  const div = document.createElement('div');
  div.className = 'message bot';
  // if contentHTML is empty or indicator, show typing indicator
  if (!contentHTML) {
    div.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
  } else {
    div.innerHTML = contentHTML;
  }
  chatBox.appendChild(div);
  saveChat();
  scrollToBottom();
  return div;
}

// Save chat to localStorage
function saveChat() {
  localStorage.setItem('roja_chat', chatBox.innerHTML);
  localStorage.setItem('roja_history', JSON.stringify(conversationHistory));
}

// New chat
function newChat(){
  if(confirm("Mulai percakapan baru?")) {
    chatBox.innerHTML = '';
    conversationHistory = [];
    appendBot("<p>Percakapan baru dimulai.<br>Halo, aku <b>Roja AI</b> ü§ñ</p>");
    saveChat();
    scrollToBottom();
  }
}

// Fullscreen toggle
function toggleFullscreen(){
  if (!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
}

// Copy text helper (target is the 'Copy' button element)
function copyText(btn){
  const pre = btn.parentElement.querySelector('pre');
  const text = pre ? pre.innerText : btn.parentElement.innerText.replace('Copy','').trim();
  navigator.clipboard.writeText(text);
  btn.textContent = '‚úÖ Disalin';
  setTimeout(()=>btn.textContent='Copy',2000);
}

/* ====== CORE: send text message or send file ====== */

// When user clicks send or presses Enter
function handleSendClick(){ sendTextOrQueuedImage(); }

userInput.addEventListener('keypress', function(e){
  if (e.key === 'Enter') { e.preventDefault(); sendTextOrQueuedImage(); }
});

// Primary send function: send text normally; if user previously uploaded a file and wants context, upload handlers call sendFileFlow directly.
async function sendTextOrQueuedImage(){
  const text = userInput.value.trim();
  if (!text) return;
  // append to UI
  appendUser(escapeHtml(text));
  userInput.value = '';
  // show typing bubble
  const typingDiv = appendBot("", true);

  // add to conversation history for context
  conversationHistory.push({ role: "user", content: text });

  try {
    // Build prompt from conversationHistory (simple concatenation)
    const prompt = conversationHistory.map(m => `${m.role === 'user' ? 'User' : 'AI'}: ${m.content}`).join("\n");

    const body = { contents: [{ parts: [{ text: prompt }] }] };

    const res = await fetch(`${GEMINI_URL}?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text || "‚ö†Ô∏è Tidak ada respons dari AI.";
    // replace typing indicator with reply
    typingDiv.innerHTML = `<pre>${escapeHtml(reply)}</pre><button class="copy-btn" onclick="copyText(this)">Copy</button>`;
    conversationHistory.push({ role: "model", content: reply });
  } catch (err) {
    console.error(err);
    typingDiv.innerHTML = "<p>‚ùå Gagal menghubungi AI. Periksa koneksi atau API key kamu.</p>";
  }

  saveChat();
  scrollToBottom();
}

/* ====== File / Image handling ======
 * - Ketika pilih file: jika gambar => preview + kirim ke AI sebagai inlineData
 * - Jika file teks/pdf/doc => dikirim sebagai inlineData (Gemini dapat menganalisis text/pdf jika supported)
 */
fileUpload.addEventListener('change', async (ev) => {
  const file = ev.target.files[0];
  if (!file) return;

  // Show user preview message (image) or filename (other)
  const reader = new FileReader();
  reader.onload = async (e) => {
    const dataUrl = e.target.result;
    const base64 = dataUrl.split(',')[1];
    const mimeType = file.type || 'application/octet-stream';

    if (mimeType.startsWith('image/')) {
      // show preview under user's message
      appendUser(`<img src="${dataUrl}" alt="${escapeHtml(file.name)}" class="preview-img"><br><i>${escapeHtml(file.name)}</i>`);
    } else {
      appendUser(`<i>üìÑ ${escapeHtml(file.name)}</i>`);
    }

    // Append bot typing indicator
    const typingDiv = appendBot("", true);

    // Build request with inlineData
    const body = {
      contents: [{
        parts: [
          { text: mimeType.startsWith('image/') ? "Jelaskan isi gambar ini secara singkat dan informatif." : `Baca dan ringkas isi file bernama ${file.name}.` },
          { inlineData: { mimeType: mimeType, data: base64 } }
        ]
      }]
    };

    try {
      const res = await fetch(`${GEMINI_URL}?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      const data = await res.json();
      const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text || "‚ö†Ô∏è Tidak ada respons dari AI.";
      typingDiv.innerHTML = `<pre>${escapeHtml(reply)}</pre><button class="copy-btn" onclick="copyText(this)">Copy</button>`;

      // Save short record to conversation history
      conversationHistory.push({ role: "user", content: `[Uploaded file: ${file.name}]` });
      conversationHistory.push({ role: "model", content: reply });

    } catch (err) {
      console.error(err);
      typingDiv.innerHTML = "<p>‚ùå Gagal memproses file/gambar. Periksa API key & koneksi.</p>";
    }

    saveChat();
    scrollToBottom();
    // reset file input so same file can be uploaded again if needed
    fileUpload.value = '';
  };

  // read as data URL (works for images and binaries)
  reader.readAsDataURL(file);
});

/* ====== Utilities ====== */

// Very small html escape helper to avoid accidental HTML injection when showing text content
function escapeHtml(str){
  if (!str && str !== 0) return '';
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

// small helper for preserving saved state when user closes/navigates
window.addEventListener('beforeunload', ()=> saveChat());
</script>
</body>
</html>
